#!/bin/bash

# Script d'initialisation pour le syst√®me de recommandation de films
# Ce script cr√©e les bases de donn√©es n√©cessaires et initialise les services

echo "üöÄ Initialisation du syst√®me de recommandation de films..."
echo ""

# V√©rifier si Docker est en cours d'ex√©cution
if ! docker info > /dev/null 2>&1; then
    echo "‚ùå Docker n'est pas en cours d'ex√©cution. Veuillez d√©marrer Docker Desktop."
    exit 1
fi

echo "‚úÖ Docker est en cours d'ex√©cution"
echo ""

# D√©marrer PostgreSQL en premier
echo "üì¶ D√©marrage de PostgreSQL..."
docker-compose up -d postgres

# Attendre que PostgreSQL soit pr√™t
echo "‚è≥ Attente de PostgreSQL..."
sleep 10

# V√©rifier que PostgreSQL est pr√™t
until docker-compose exec -T postgres pg_isready -U airflow > /dev/null 2>&1; do
    echo "‚è≥ En attente de PostgreSQL..."
    sleep 2
done

echo "‚úÖ PostgreSQL est pr√™t"
echo ""

# Cr√©er la base de donn√©es MLflow
echo "üìä Cr√©ation de la base de donn√©es MLflow..."
docker-compose exec -T postgres psql -U airflow -c "CREATE DATABASE mlflow;" 2>/dev/null || echo "‚ÑπÔ∏è  La base de donn√©es MLflow existe d√©j√†"
echo "‚úÖ Base de donn√©es MLflow cr√©√©e"
echo ""

# D√©marrer tous les services
echo "üöÄ D√©marrage de tous les services..."
docker-compose up -d

echo ""
echo "‚úÖ Tous les services sont en cours de d√©marrage!"
echo ""
echo "üìã Acc√®s aux services:"
echo "   - Kafka UI:        http://localhost:8080"
echo "   - Spark Master:    http://localhost:8081"
echo "   - Airflow:         http://localhost:8082 (admin/admin)"
echo "   - MLflow:          http://localhost:5000"
echo "   - Grafana:         http://localhost:3000 (admin/admin)"
echo "   - Prometheus:      http://localhost:9090"
echo "   - FastAPI:         http://localhost:8000"
echo "   - FastAPI Docs:    http://localhost:8000/docs"
echo ""
echo "‚è≥ Attendez quelques instants que tous les services soient pr√™ts..."
echo "   Vous pouvez v√©rifier l'√©tat avec: docker-compose ps"
echo "   Voir les logs avec: docker-compose logs -f [service-name]"
echo ""

